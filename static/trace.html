<!DOCTYPE html> 
<head>
    <title>My page</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
</head>
<body>
    
   <script>
       let array = [];
       let timeStampChart = [];

       let distanceChart = [];

       let csvContent = "data:text/csv;charset=utf-8,";
       var body = document.getElementsByTagName("body")[0];

        var tbl = document.createElement("table");
        var tblBody = document.createElement("tbody");

        var row = document.createElement("tr");
        var cell = document.createElement("th");
        var cellText = document.createTextNode("Index");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("Timestamp");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("X");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("Y");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("MovingScale");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("FixedScale");
        cell.appendChild(cellText);
        row.appendChild(cell);

        var cell = document.createElement("th");
        var cellText = document.createTextNode("Collision");
        cell.appendChild(cellText);
        row.appendChild(cell);

        tblBody.append(row);



        const dbrequest = window.indexedDB.open("gamejamdb");
            dbrequest.onupgradeneeded = () => {
                
            }
            dbrequest.onerror = function(event) {
            // Do something with request.errorCode!
            };
            dbrequest.onsuccess = function(event) {
                console.log("Successful");
                let db = dbrequest.result;

                var objectStore = db.transaction(["data1"], 'readwrite').objectStore("data1");

                objectStore.openCursor().onsuccess = function(event) {
                var cursor = event.target.result;
                if (cursor) {
                    let singleInfo = [];
                    singleInfo.push(cursor.value.timeStamp.toString());

                    timeStampChart.push(cursor.value.timeStamp.toString());

                    singleInfo.push(cursor.value.xCoord.toString());

                    var xVal = parseFloat(cursor.value.xCoord.toString());
                    var yVal = parseFloat(cursor.value.yCoord.toString());

                    if(array.length > 0) {
                        var prevX = parseFloat(array[array.length-1][1]);
                        var prevY = parseFloat(array[array.length-1][2]);

                    }
                    else {
                        prevX = 100;
                        prevY = 300;
                    }

                    distanceChart.push(Math.sqrt((xVal-prevX)*(xVal-prevX) + (yVal-prevY)*(yVal-prevY)));




                    singleInfo.push(cursor.value.yCoord.toString());
                    singleInfo.push(cursor.value.fixedObjScale.toString());
                    singleInfo.push(cursor.value.movingObjScale.toString());
                    singleInfo.push(cursor.value.collision.toString());



                        // timeStamp: cursor.value.timeStamp,
                        // xCoord: cursor.value.xCoord,
                        // yCoord: cursor.value.yCoord,
                        // fixedObjScale : cursor.value.fixedObjScale,
                        // movingObjScale : cursor.value.movingObjScale,
                        // collision: cursor.value.collision
                    array.push(singleInfo);
                    cursor.continue();
                }
                else {
                    console.log("No more entries!");
                    console.log(array.length);
                    for (var i = 0; i < array.length; i++) {
                        
                        
                        var row = document.createElement("tr");

                        csvContent += array[i].join();
                        csvContent += "\r\n";

                        

                        var cell = document.createElement("td");
                        var cellText = document.createTextNode(i+1);
                        cell.appendChild(cellText);
                        row.appendChild(cell);


                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][0]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);

                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][1]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);

                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][2]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);

                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][4]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);

                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][3]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);

                        cell = document.createElement("td");
                        var cellText = document.createTextNode(array[i][5]);
                        cell.appendChild(cellText);
                        row.appendChild(cell);
                    

                        
                    tblBody.appendChild(row);
                    }

                    //var encodedUri = encodeURI(csvContent);
                    //window.open(encodedUri);

                    // put the <tbody> in the <table>
                    tbl.appendChild(tblBody);
                    tbl.style.float = "left";
                    // appends <table> into <body>
                    body.appendChild(tbl);
                    // sets the border attribute of tbl to 2;
                    tbl.setAttribute("border", "0");
                    tbl.setAttribute("cellspacing", "5px");
                    loadChart();


                    var body1 = document.getElementsByTagName("body")[0];

                    var tbl1 = document.createElement("table");
                    var tblBody1 = document.createElement("tbody");

                    var row1 = document.createElement("tr");

                    var cell1 = document.createElement("td");
                    var cellText1 = document.createTextNode("Mean");
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);


                    cell1 = document.createElement("td");
                    var meanDist = 0;
                    for(var i=0; i < distanceChart.length; i++ ) {
                        meanDist += distanceChart[i];
                    }
                    if(distanceChart.length != 0)
                        meanDist = meanDist/distanceChart.length;
                    var cellText1 = document.createTextNode(meanDist);
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);

                    tblBody1.appendChild(row1);



                    var row1 = document.createElement("tr");

                    var cell1 = document.createElement("td");
                    var cellText1 = document.createTextNode("Max");
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);


                    cell1 = document.createElement("td");
                    var maxDist = 0;
                    for(var i=0; i < distanceChart.length; i++ ) {
                        if(distanceChart[i] > maxDist) {
                            maxDist = distanceChart[i];
                        }
                    }
                
                    var cellText1 = document.createTextNode(maxDist);
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);

                    tblBody1.appendChild(row1);


                    var row1 = document.createElement("tr");

                    var cell1 = document.createElement("td");
                    var cellText1 = document.createTextNode("Min");
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);


                    cell1 = document.createElement("td");
                    var minDist = 10000;
                    for(var i=0; i < distanceChart.length; i++ ) {
                        if(distanceChart[i] < minDist) {
                            minDist = distanceChart[i];
                        }
                    }
                
                    var cellText1 = document.createTextNode(minDist);
                    cell1.appendChild(cellText1);
                    row1.appendChild(cell1);

                    tblBody1.appendChild(row1);

                    // put the <tbody> in the <table>
                    tbl1.appendChild(tblBody1);
                    tbl1.style.float = "right";
                    // appends <table> into <body>
                    body1.appendChild(tbl1);
                    // sets the border attribute of tbl to 2;
                    tbl1.setAttribute("border", "0");
                    tbl1.setAttribute("cellspacing", "5px");

                }
                };

            };


            

        
   </script>
   <div>
        <canvas id="myChart" width="1400" height="900"></canvas>
    </div>

    <script>
        function loadChart() {
            const labels = timeStampChart;
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Distance between consecutive interations',
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: distanceChart,
                }]
            };

            const config = {
                type: 'line',
                data,
                options: {
                    responsive: false
                }
            };
        
            var myChart = new Chart(
                document.getElementById('myChart'),
                config
            );

        }
    
    </script>

  
</body>
</html>